<html><head>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.0/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
  font-family: Arial, sans-serif;
  background-color: #f0f0f0;
  color: #333;
}

.custom-nav {
      background-color: #343a40;
      padding: 10px 0;
      margin-bottom: 1.5rem;
    }
    .custom-nav ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .custom-nav li {
      margin: 5px 10px;
    }
    .custom-nav a {
      color: white;
      text-decoration: none;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    .custom-nav a:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    @media (max-width: 768px) {
      .custom-nav ul {
        flex-direction: column;
        align-items: center;
      }
      .custom-nav li {
        margin: 5px 0;
      }
    }

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

header, footer {
  background-color: #5d0000;
  color: white;
  padding: 10px 0;
  text-align: center;
}

nav {
  background-color: #7a0000;
}

.nav-link {
  color: white !important;
}

.nav-link:hover {
  background-color: #9a0000;
}

section {
  background-color: white;
  border-radius: 5px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

h2 {
  color: #5d0000;
  border-bottom: 2px solid #5d0000;
  padding-bottom: 10px;
}

table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

th {
  background-color: #f2f2f2;
}

button {
  background-color: #5d0000;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
}

button:hover {
  background-color: #7a0000;
}

.form-select, .form-control {
  margin-bottom: 10px;
}

.hidden {
  display: none;
}

@media (max-width: 768px) {
  .container {
    padding: 10px;
  }
  
  table {
    font-size: 14px;
  }
  
  button {
    width: 100%;
    margin-bottom: 10px;
  }
}

#pembimbingFilter:not(:empty) ~ * {
  display: block;
}

#pembimbingFilter:empty ~ * {
  display: none;
}

/* Tambahkan CSS berikut */
.sticky-col {
  position: sticky;
  left: 0;
  background-color: white;
  z-index: 1;
}

.hadir {
  background-color: #1ed31e; /* Hijau muda */
}

.alpha {
  background-color: #f34963; /* Merah muda */
}

.izin {
  background-color: #fafa0b; /* Kuning muda */
}

.sakit {
  background-color: #300480; /* Biru muda */
}

.sunday, .sunday-header {
  background-color: #e92240; /* Merah muda */
}

/* Gaya untuk baris yang dinonaktifkan */
tr.disabled td {
  background-color: #f0f0f0;
  color: #888;
}

/* CSS untuk Monitoring Orang Tua */
#monitoringOrangTua .card {
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  padding: 20px;
  margin-bottom: 20px;
}

#monitoringOrangTua .form-group {
  margin-bottom: 15px;
}

#monitoringOrangTua label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

#monitoringOrangTua input[type="text"] {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

#monitoringOrangTua button {
  background-color: #5d0000;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}

#monitoringOrangTua button:hover {
  background-color: #7a0000;
}

#studentInfo, #attendanceMessage, #parentNote {
  margin-top: 20px;
}

#studentInfo h3, #attendanceMessage h3, #parentNote h3 {
  color: #5d0000;
  border-bottom: 2px solid #5d0000;
  padding-bottom: 10px;
  margin-bottom: 15px;
}

.attendance-info {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
}

.attendance-item {
  flex-basis: 48%;
  background-color: #f9f9f9;
  border-radius: 4px;
  padding: 10px;
  margin-bottom: 10px;
  text-align: center;
}

.attendance-item .count {
  font-size: 24px;
  font-weight: bold;
  color: #5d0000;
}

.attendance-item .label {
  font-size: 14px;
  color: #666;
}

.attendance-item .dates {
  font-size: 12px;
  color: #888;
  margin-top: 5px;
}

#messageContent {
  background-color: #f0f0f0;
  border-left: 4px solid #5d0000;
  padding: 15px;
  margin-top: 15px;
}

#messageContent p {
  margin-bottom: 10px;
}

#messageContent ul {
  padding-left: 20px;
}

.note-card {
  background-color: #f9f9f9;
  border-left: 4px solid #5d0000;
  padding: 10px;
  margin-bottom: 10px;
}

.note-date {
  font-size: 12px;
  color: #888;
  margin-bottom: 5px;
}

@media (max-width: 768px) {
  .attendance-item {
    flex-basis: 100%;
  }
}

/* CSS untuk Catatan Guru */
#catatanGuru .form-group {
  margin-bottom: 15px;
}

#catatanGuru label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

#catatanGuru input[type="text"],
#catatanGuru textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

#catatanGuru button {
  background-color: #5d0000;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
}

#catatanGuru button:hover {
  background-color: #7a0000;
}

#studentList {
  list-style-type: none;
  padding: 0;
  margin: 0;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-top: none;
  display: none;
}

#studentList li {
  padding: 8px;
  cursor: pointer;
}

#studentList li:hover {
  background-color: #f0f0f0;
}

#noteList {
  margin-top: 20px;
}

#noteList h4 {
  color: #5d0000;
  border-bottom: 2px solid #5d0000;
  padding-bottom: 5px;
}

#noteList p {
  margin-bottom: 10px;
  padding: 10px;
  background-color: #f9f9f9;
  border-left: 3px solid #5d0000;
}

/* CSS untuk Edit Kehadiran */
#editKehadiran .form-group {
  margin-bottom: 15px;
}

#editKehadiran label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
}

#editKehadiran input[type="date"] {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

#editKehadiran button {
  background-color: #5d0000;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s;
  margin-right: 10px;
}

#editKehadiran button:hover {
  background-color: #7a0000;
}

#editTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

#editTable th,
#editTable td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

#editTable th {
  background-color: #f2f2f2;
  font-weight: bold;
}

#editTable input[type="radio"] {
  margin-right: 5px;
}

#editTable tr.disabled {
  background-color: #f0f0f0;
  color: #888;
}

#editTable tr.disabled input[type="radio"] {
  cursor: not-allowed;
}

/* Gaya untuk judul */
.main-title {
  font-family: 'Arial', sans-serif;
  font-size: 3rem;
  font-weight: bold;
  text-align: center;
  color: #5d0000;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  margin: 20px 0;
  padding: 20px;
  background: linear-gradient(45deg, #f6d365 0%, #fda085 100%);
  border-radius: 10px;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  animation: titleGlow 2s ease-in-out infinite alternate;
}

@keyframes titleGlow {
  from {
    box-shadow: 0 0 5px #f6d365, 0 0 10px #fda085;
  }
  to {
    box-shadow: 0 0 20px #f6d365, 0 0 30px #fda085;
  }
}

/* Gaya untuk container judul */
.title-container {
  background-color: rgba(255,255,255,0.8);
  padding: 10px;
  border-radius: 15px;
  margin-bottom: 30px;
}

</style>
</head>
<body>
  <header>
    <h1>Rumah Tahfidz Saijaan</h1>
  </header>
  
  <div class="title-container">
    <h1 class="main-title">ABSEN DIGITAL KEHADIRAN SANTRI</h1>
  </div>
  
  <div class="filter-container mb-3">
    <select id="pembimbingFilter" class="form-select awesome-select">
      <option value="">Pilih Pembimbing Baru</option>
    </select>
    <select id="statusFilter" class="form-select awesome-select" disabled>
      <option value="">Pilih Status</option>
    </select>
  </div>

  <style>
    .filter-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin: 30px auto;
      max-width: 600px;
    }
    
    .awesome-select {
      appearance: none;
      background-color: #f8f9fa;
      border: 2px solid #5d0000;
      border-radius: 50px;
      padding: 12px 20px;
      font-size: 16px;
      color: #5d0000;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      text-align-last: center;
      width: 100%;
    }
    
    .awesome-select:hover, .awesome-select:focus {
      background-color: #5d0000;
      color: #fff;
      box-shadow: 0 0 15px rgba(93, 0, 0, 0.5);
    }
    
    .awesome-select option {
      background-color: #fff;
      color: #5d0000;
    }
    
    @media (max-width: 768px) {
      .filter-container {
        flex-direction: column;
      }
    }
  </style>

  <nav class="custom-nav" style="display: none;">
    <ul>
      <li><a href="#" onclick="showSection('absensiHarian')">Absensi Harian</a></li>
      <li><a href="#" onclick="showSection('rekapAbsensi')">Rekap Absensi</a></li>
      <li><a href="#" onclick="showSection('monitoringOrangTua')">Monitoring Orang Tua</a></li>
      <li><a href="#" onclick="showSection('catatanGuru')">Catatan Guru</a></li>
      <li><a href="#" onclick="showSection('editKehadiran')">Edit Kehadiran</a></li>
    </ul>
  </nav>

  
  <div class="container">
    <section id="absensiHarian">
      <h2>Absensi Harian</h2>
      <p>Tanggal: <span id="currentDate"></span></p>
      <div class="table-responsive">
      <table id="absensiTable">
        <thead>
          <tr>
            <th>No.</th>
            <th>Nama</th>
            <th>Hadir</th>
            <th>Sakit</th>
            <th>Izin</th>
            <th>Alpha</th>
          </tr>
        </thead>
        <tbody id="absensiBody"></tbody>
      </table>
      </div>
      <button onclick="simpanAbsensi()">Simpan Absensi</button>
    </section>

    <section id="rekapAbsensi" class="hidden">
      <h2>Rekap Absensi</h2>
      <select id="monthSelect" onchange="updateRekapAbsensi()">
        <option value="0">Januari</option>
        <option value="1">Februari</option>
        <option value="2">Maret</option>
        <option value="3">April</option>
        <option value="4">Mei</option>
        <option value="5">Juni</option>
        <option value="6">Juli</option>
        <option value="7">Agustus</option>
        <option value="8">September</option>
        <option value="9">Oktober</option>
        <option value="10">November</option>
        <option value="11">Desember</option>
      </select>
      <table id="rekapTable">
        <thead id="rekapHead"></thead>
        <tbody id="rekapBody"></tbody>
      </table>
      <button id="downloadExcelBtn" onclick="downloadExcel()">Download Excel</button>
    </section>

    <section id="monitoringOrangTua" class="hidden">
      <h2>Monitoring Orang Tua</h2>
      <div class="card">
        <div class="form-group">
          <label for="noinfaqInput">Nomor Infaq:</label>
          <input type="text" id="noinfaqInput" placeholder="Masukkan No. Infaq">
        </div>
        <button onclick="searchStudent()" class="btn-primary">Cari</button>
      </div>
      <div id="studentInfo"></div>
      <div id="attendanceMessage" class="card hidden">
        <h3>Pemberitahuan Kehadiran</h3>
        <p id="messageContent"></p>
      </div>
      <div id="parentNote"></div>
    </section>

    <section id="catatanGuru" class="hidden">
      <h2>Catatan Guru</h2>
      <div class="form-group">
        <label for="studentSearch">Cari Siswa:</label>
        <input type="text" id="studentSearch" placeholder="Ketik nama siswa">
        <ul id="studentList" class="autocomplete-list"></ul>
      </div>
      <div class="form-group">
        <label for="noteInput">Catatan:</label>
        <textarea id="noteInput" rows="4" cols="50"></textarea>
      </div>
      <button onclick="saveNote()">Simpan Catatan</button>
      <div id="noteList"></div>
    </section>

    <section id="editKehadiran" class="hidden">
      <h2>Edit Kehadiran</h2>
      <div class="form-group">
        <label for="editDate">Pilih Tanggal:</label>
        <input type="date" id="editDate">
      </div>
      <button onclick="loadAttendanceForEdit()">Muat Data</button>
      <table id="editTable" class="hidden">
        <thead>
          <tr>
            <th>No.</th>
            <th>Nama</th>
            <th>Hadir</th>
            <th>Sakit</th>
            <th>Izin</th>
            <th>Alpha</th>
          </tr>
        </thead>
        <tbody id="editBody"></tbody>
      </table>
      <button onclick="saveEditedAttendance()" class="hidden" id="saveEditBtn">Simpan Perubahan</button>
      <button onclick="downloadAttendanceData()" class="hidden" id="downloadDataBtn">Unduh Data Kehadiran</button>
    </section>
  </div>
<script src="js/script2.js"></script>
  <script>

    let dailyAttendance = {};
    let studentNotes = {};

    function initializeFilters() {
      const pembimbingFilter = document.getElementById('pembimbingFilter');
      const statusFilter = document.getElementById('statusFilter');
      const uniquePembimbings = [...new Set(data.map(item => item['PEMBIMBING BARU']))];
      
      uniquePembimbings.forEach(pembimbing => {
        const option = document.createElement('option');
        option.value = pembimbing;
        option.textContent = pembimbing;
        pembimbingFilter.appendChild(option);
      });

      pembimbingFilter.addEventListener('change', function() {
        statusFilter.disabled = !this.value;
        statusFilter.innerHTML = '<option value="">Pilih Status</option>';
        if (this.value) {
          const filteredData = data.filter(item => item['PEMBIMBING BARU'] === this.value);
          const uniqueStatuses = [...new Set(filteredData.map(item => item.STATUS))];
          uniqueStatuses.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            statusFilter.appendChild(option);
          });
        }
      });

      statusFilter.addEventListener('change', function() {
        if (this.value) {
          document.querySelector('nav').style.display = 'block';
          showSection('absensiHarian');
        }
      });
    }

    function showSection(sectionId) {
      document.querySelectorAll('section').forEach(section => {
        section.classList.add('hidden');
      });
      document.getElementById(sectionId).classList.remove('hidden');
      if (sectionId === 'absensiHarian') {
        initializeAbsensiHarian();
      } else if (sectionId === 'rekapAbsensi') {
        updateRekapAbsensi();
      } else if (sectionId === 'catatanGuru') {
        initializeCatatanGuru();
      }
    }

    function initializeAbsensiHarian() {
      const currentDate = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const formattedDate = currentDate.toLocaleDateString('id-ID', options);
      document.getElementById('currentDate').textContent = formattedDate;
      const absensiBody = document.getElementById('absensiBody');
      absensiBody.innerHTML = '';
      
      const pembimbing = document.getElementById('pembimbingFilter').value;
      const status = document.getElementById('statusFilter').value;
      const filteredData = data.filter(item => item['PEMBIMBING BARU'] === pembimbing && item.STATUS === status);
      
      filteredData.forEach((student, index) => {
        const row = document.createElement('tr');
        const isSunday = new Date().getDay() === 0;
        const savedAttendance = localStorage.getItem(`attendance_${student.NOINFAQ}_${currentDate}`);
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${student.NAMA}</td>
          <td><input type="radio" name="attendance_${student.NOINFAQ}" value="hadir" ${savedAttendance === 'hadir' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="attendance_${student.NOINFAQ}" value="sakit" ${savedAttendance === 'sakit' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="attendance_${student.NOINFAQ}" value="izin" ${savedAttendance === 'izin' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="attendance_${student.NOINFAQ}" value="alpha" ${savedAttendance === 'alpha' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
        `;
        if (student.STATUS === 'TAHFIDZ') {
          row.classList.add('status-tahfidz');
        }
        if (isSunday) {
          row.classList.add('disabled');
        }
        absensiBody.appendChild(row);

        // Tambahkan event listener untuk menyimpan status kehadiran ke localStorage
        const radioButtons = row.querySelectorAll('input[type="radio"]');
        radioButtons.forEach(radio => {
          radio.addEventListener('change', function() {
            localStorage.setItem(`attendance_${student.NOINFAQ}_${currentDate}`, this.value);
          });
        });
      });
    }

    function simpanAbsensi() {
      const currentDate = new Date().toISOString().split('T')[0];
      const absensiData = {};
      data.forEach(student => {
        const attendance = document.querySelector(`input[name="attendance_${student.NOINFAQ}"]:checked`);
        if (attendance) {
          absensiData[student.NOINFAQ] = attendance.value;
        }
      });
      
      db.collection('dailyAttendance').doc(currentDate).set(absensiData)
        .then(() => {
          alert('Absensi berhasil disimpan!');
          dailyAttendance[currentDate] = absensiData; // Perbarui data lokal
          updateRekapAbsensi(); // Perbarui tampilan
        })
        .catch((error) => {
          console.error("Error writing document: ", error);
          alert('Terjadi kesalahan saat menyimpan absensi.');
        });
    }

    function updateRekapAbsensi() {
      const month = document.getElementById('monthSelect').value;
      const year = new Date().getFullYear();
      const daysInMonth = new Date(year, parseInt(month) + 1, 0).getDate();
      
      const rekapHead = document.getElementById('rekapHead');
      const rekapBody = document.getElementById('rekapBody');

      const pembimbing = document.getElementById('pembimbingFilter').value;
      const status = document.getElementById('statusFilter').value;
      const filteredData = data.filter(item => item['PEMBIMBING BARU'] === pembimbing && item.STATUS === status);

      let headerRow = '<tr><th class="sticky-col">No</th><th class="sticky-col">Nama</th>';
      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(year, parseInt(month), i);
        const isSunday = date.getDay() === 0;
        headerRow += `<th class="${isSunday ? 'sunday-header' : ''}">${i}</th>`;
      }
      headerRow += '</tr>';
      rekapHead.innerHTML = headerRow;
      
      rekapBody.innerHTML = '';
      filteredData.forEach((student, index) => {
        let row = `<tr><td class="sticky-col">${index + 1}</td><td class="sticky-col">${student.NAMA}</td>`;
        for (let i = 1; i <= daysInMonth; i++) {
          const date = `${year}-${(parseInt(month) + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
          const isSunday = new Date(date).getDay() === 0;
          const attendanceStatus = dailyAttendance[date] && dailyAttendance[date][student.NOINFAQ] ? dailyAttendance[date][student.NOINFAQ] : '';
          row += `<td class="${isSunday ? 'sunday' : ''} ${attendanceStatus}">${isSunday ? '-' : (attendanceStatus.charAt(0).toUpperCase() || '-')}</td>`;
        }
        row += '</tr>';
        rekapBody.innerHTML += row;
      });
    }

    function downloadExcel() {
      const month = document.getElementById('monthSelect').value;
      const year = new Date().getFullYear();
      const pembimbing = document.getElementById('pembimbingFilter').value;
      const status = document.getElementById('statusFilter').value;

      // Membuat workbook dan worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(document.getElementById('rekapTable'));

      // Mengatur nama file
      const fileName = `Rekap_Absensi_${pembimbing}_${status}_${year}_${parseInt(month) + 1}.xlsx`;

      // Menambahkan worksheet ke workbook
      XLSX.utils.book_append_sheet(wb, ws, "Rekap Absensi");

      // Mengunduh file Excel
      XLSX.writeFile(wb, fileName);
    }

    function searchStudent() {
      const noinfaq = document.getElementById('noinfaqInput').value;
      const student = data.find(s => s.NOINFAQ === noinfaq);
      const studentInfo = document.getElementById('studentInfo');
      const parentNote = document.getElementById('parentNote');
      const attendanceMessage = document.getElementById('attendanceMessage');
      const messageContent = document.getElementById('messageContent');
      
      if (student) {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        let attendanceSummary = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
        let attendanceDates = { sakit: [], izin: [], alpha: [] };
        
        Object.entries(dailyAttendance).forEach(([date, day]) => {
          const attendanceDate = new Date(date);
          if (attendanceDate.getMonth() === currentMonth && attendanceDate.getFullYear() === currentYear) {
            if (day[noinfaq]) {
              attendanceSummary[day[noinfaq]]++;
              if (['sakit', 'izin', 'alpha'].includes(day[noinfaq])) {
                attendanceDates[day[noinfaq]].push(attendanceDate);
              }
            }
          }
        });
        
        let attendanceHtml = '';
        ['hadir', 'sakit', 'izin', 'alpha'].forEach(status => {
          attendanceHtml += `
            <div class="attendance-item">
              <div class="count">${attendanceSummary[status]}</div>
              <div class="label">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
              ${status !== 'hadir' ? `<div class="dates">Tanggal: ${attendanceDates[status].map(d => d.toLocaleDateString('id-ID')).join(', ')}</div>` : ''}
            </div>
          `;
        });
        
        studentInfo.innerHTML = `
          <div class="card">
            <h3>${student.NAMA}</h3>
            <p><strong>No. Infaq:</strong> ${student.NOINFAQ}</p>
            <p><strong>Pembimbing:</strong> ${student["PEMBIMBING BARU"]}</p>
            <p><strong>Kelas:</strong> ${student.STATUS}</p>
            <h4>Ringkasan Kehadiran Bulan Ini:</h4>
            <div class="attendance-info">
              ${attendanceHtml}
            </div>
          </div>
        `;
        
        // Membuat pesan otomatis
        let message = '';
        ['sakit', 'izin', 'alpha'].forEach(status => {
          if (attendanceDates[status].length > 0) {
            message += `Ananda tidak hadir karena ${status} pada tanggal: ${attendanceDates[status].map(d => d.toLocaleDateString('id-ID')).join(', ')}.\n`;
          }
        });
        
        if (message) {
          messageContent.innerHTML = `
            <p>Yth. Orang Tua/Wali dari ${student.NAMA},</p>
            <p>Kami ingin memberitahukan bahwa:</p>
            <p>${message}</p>
            <p>Total kehadiran bulan ini:</p>
            <ul>
              <li>Hadir: ${attendanceSummary.hadir} hari</li>
              <li>Sakit: ${attendanceSummary.sakit} hari</li>
              <li>Izin: ${attendanceSummary.izin} hari</li>
              <li>Alpha: ${attendanceSummary.alpha} hari</li>
            </ul>
            <p>Hormat kami,<br>Rumah Tahfidz Saijaan</p>
          `;
          attendanceMessage.classList.remove('hidden');
        } else {
          attendanceMessage.classList.add('hidden');
        }
        
        const notes = studentNotes[noinfaq] || [];
        parentNote.innerHTML = `
          <div class="card">
            <h3>Catatan Guru:</h3>
            ${notes.length > 0 ? notes.map(note => `
              <div class="note-card">
                <div class="note-date">${new Date(note.date).toLocaleString('id-ID')}</div>
                <div>${note.note}</div>
              </div>
            `).join('') : '<p>Belum ada catatan.</p>'}
          </div>
        `;
      } else {
        studentInfo.innerHTML = '<div class="card"><p>Siswa tidak ditemukan.</p></div>';
        parentNote.innerHTML = '';
        attendanceMessage.classList.add('hidden');
      }
    }

    function initializeCatatanGuru() {
      const studentSearch = document.getElementById('studentSearch');
      const studentList = document.getElementById('studentList');

      studentSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredStudents = data.filter(student => 
          student.NAMA.toLowerCase().includes(searchTerm)
        );

        studentList.innerHTML = '';
        studentList.style.display = filteredStudents.length > 0 ? 'block' : 'none';

        filteredStudents.forEach(student => {
          const li = document.createElement('li');
          li.textContent = student.NAMA;
          li.onclick = function() {
            studentSearch.value = student.NAMA;
            studentList.style.display = 'none';
            updateNoteList(student.NOINFAQ);
          };
          studentList.appendChild(li);
        });
      });

      updateNoteList();
    }

    function saveNote() {
      const studentName = document.getElementById('studentSearch').value;
      const student = data.find(s => s.NAMA === studentName);
      if (!student) {
        alert('Silakan pilih siswa terlebih dahulu.');
        return;
      }

      const note = document.getElementById('noteInput').value;
      const noteData = {
        date: new Date().toISOString(),
        note: note
      };

      // Simpan catatan ke Firebase
      db.collection('studentNotes').doc(student.NOINFAQ).collection('notes').add(noteData)
        .then(() => {
          if (!studentNotes[student.NOINFAQ]) {
            studentNotes[student.NOINFAQ] = [];
          }
          studentNotes[student.NOINFAQ].push(noteData);
          document.getElementById('noteInput').value = '';
          updateNoteList(student.NOINFAQ);
          alert('Catatan berhasil disimpan!');
        })
        .catch((error) => {
          console.error("Error saving note: ", error);
          alert('Terjadi kesalahan saat menyimpan catatan.');
        });
    }

    function updateNoteList(noinfaq) {
      const noteList = document.getElementById('noteList');
      if (!noinfaq) {
        noteList.innerHTML = '<p>Pilih siswa untuk melihat catatan.</p>';
        return;
      }

      // Ambil catatan dari Firebase
      db.collection('studentNotes').doc(noinfaq).collection('notes')
        .orderBy('date', 'desc')
        .limit(5)
        .get()
        .then((querySnapshot) => {
          noteList.innerHTML = '<h4>Catatan Terbaru:</h4>';
          querySnapshot.forEach((doc) => {
            const note = doc.data();
            noteList.innerHTML += `<p>${new Date(note.date).toLocaleString()}: ${note.note}</p>`;
          });
        })
        .catch((error) => {
          console.error("Error getting notes: ", error);
          noteList.innerHTML = '<p>Terjadi kesalahan saat mengambil catatan.</p>';
        });
    }

    function loadAttendanceForEdit() {
      const editDate = document.getElementById('editDate').value;
      const editBody = document.getElementById('editBody');
      editBody.innerHTML = '';
      
      const pembimbing = document.getElementById('pembimbingFilter').value;
      const status = document.getElementById('statusFilter').value;
      const filteredData = data.filter(item => item['PEMBIMBING BARU'] === pembimbing && item.STATUS === status);
      
      filteredData.forEach((student, index) => {
        const row = document.createElement('tr');
        const attendance = dailyAttendance[editDate] ? dailyAttendance[editDate][student.NOINFAQ] : '';
        const isSunday = new Date(editDate).getDay() === 0;
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${student.NAMA}</td>
          <td><input type="radio" name="edit_attendance_${student.NOINFAQ}" value="hadir" ${attendance === 'hadir' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="edit_attendance_${student.NOINFAQ}" value="sakit" ${attendance === 'sakit' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="edit_attendance_${student.NOINFAQ}" value="izin" ${attendance === 'izin' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="edit_attendance_${student.NOINFAQ}" value="alpha" ${attendance === 'alpha' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
        `;
        if (isSunday) {
          row.classList.add('disabled');
        }
        editBody.appendChild(row);
      });
      
      document.getElementById('editTable').classList.remove('hidden');
      document.getElementById('saveEditBtn').classList.remove('hidden');
      document.getElementById('downloadDataBtn').classList.remove('hidden');
    }

    function saveEditedAttendance() {
      const editDate = document.getElementById('editDate').value;
      const editedData = {};
      
      data.forEach(student => {
        const attendance = document.querySelector(`input[name="edit_attendance_${student.NOINFAQ}"]:checked`);
        if (attendance) {
          editedData[student.NOINFAQ] = attendance.value;
        }
      });
      
      db.collection('dailyAttendance').doc(editDate).set(editedData)
        .then(() => {
          alert('Perubahan absensi berhasil disimpan!');
          dailyAttendance[editDate] = editedData; // Perbarui data lokal
          updateRekapAbsensi(); // Perbarui tampilan
        })
        .catch((error) => {
          console.error("Error updating document: ", error);
          alert('Terjadi kesalahan saat menyimpan perubahan absensi.');
        });
    }

    function downloadAttendanceData() {
      db.collection('dailyAttendance').get()
        .then((querySnapshot) => {
          const attendanceData = {};
          querySnapshot.forEach((doc) => {
            attendanceData[doc.id] = doc.data();
          });
          
          const wb = XLSX.utils.book_new();
          const wsData = Object.entries(attendanceData).flatMap(([date, attendance]) => 
            Object.entries(attendance).map(([noinfaq, status]) => ({
              Tanggal: date,
              'No. Infaq': noinfaq,
              Nama: data.find(s => s.NOINFAQ === noinfaq)?.NAMA || '',
              Status: status
            }))
          );
          const ws = XLSX.utils.json_to_sheet(wsData);

          XLSX.utils.book_append_sheet(wb, ws, "Data Kehadiran");
          XLSX.writeFile(wb, "Data_Kehadiran.xlsx");
        })
        .catch((error) => {
          console.error("Error downloading attendance data: ", error);
          alert("Terjadi kesalahan saat mengunduh data kehadiran.");
        });
    }

    // Fungsi untuk memuat data kehadiran dari Firestore
    function loadAttendanceData() {
      db.collection('dailyAttendance').get()
        .then((querySnapshot) => {
          dailyAttendance = {};
          querySnapshot.forEach((doc) => {
            dailyAttendance[doc.id] = doc.data();
          });
          console.log('Data kehadiran berhasil dimuat');
          updateRekapAbsensi(); // Memperbarui tampilan setelah data dimuat
        })
        .catch((error) => {
          console.error("Error loading attendance data: ", error);
        });
    }

    // Panggil fungsi loadAttendanceData saat halaman dimuat
    document.addEventListener('DOMContentLoaded', loadAttendanceData);

    // Initialize the page
    initializeFilters();
    showSection('absensiHarian');
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    // Konfigurasi Firebase Anda
       // Konfigurasi Firebase Anda
       const firebaseConfig = {
      apiKey: "AIzaSyB4xPZNU7xb8mXR85gcR9HfLmfHmZeb_zI",
      authDomain: "inputsiswa-1af9a.firebaseapp.com",
      projectId: "inputsiswa-1af9a",
      storageBucket: "inputsiswa-1af9a.appspot.com",
      messagingSenderId: "706431942569",
      appId: "1:706431942569:web:3e36ac6a1d618617868eb8"
    };
    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    // Fungsi untuk mengatur bulan default
    function setDefaultMonth() {
      const currentMonth = new Date().getMonth();
      document.getElementById('monthSelect').value = currentMonth;
      updateRekapAbsensi();
    }

    // Panggil fungsi setDefaultMonth saat halaman dimuat
    window.onload = function() {
      setDefaultMonth();
      // ... kode lainnya yang perlu dijalankan saat halaman dimuat ...
    };
  </script>
</body>
</html>