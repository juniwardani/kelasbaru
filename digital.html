<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">

<style>
/* General Styles */
body {
    font-family: 'Amiri', serif; /* Font islami */
    background-color: #f8f3e6; /* Warna latar belakang krem lembut */
    color: #3c3c3c;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

h1, h2 {
    text-align: center;
}

.container {
    padding: 20px;
    max-width: 100%;
    margin: 0 auto;
}

.hidden {
    display: none;
}

.table-responsive {
    overflow-x: auto;
    position: relative;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

th, td {
    padding: 10px;
    text-align: left;
    border: 1px solid #ddd;
}

/* Filter Dropdowns */
.filter-container {
    background-color: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.row {
    display: flex;
    flex-wrap: wrap;
    margin-right: -15px;
    margin-left: -15px;
}

.col-md-6 {
    position: relative;
    width: 100%;
    padding-right: 15px;
    padding-left: 15px;
}

@media (min-width: 768px) {
    .col-md-6 {
        flex: 0 0 50%;
        max-width: 50%;
    }
    
    .mb-md-0 {
        margin-bottom: 0 !important;
    }
}

.awesome-select {
    width: 100%;
    padding: 10px;
    font-size: 1rem;
    border: 2px solid #1c4e80;
    border-radius: 5px;
    background-color: #f0f0f0;
    color: #3c3c3c;
    transition: all 0.3s ease;
}

.awesome-select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(28, 78, 128, 0.3);
}

/* Buttons */
button {
    padding: 10px 20px;
    background-color: #007BFF;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    width: 100%;
    margin: 10px 0;
}

/* Form Groups */
.form-group {
    margin-bottom: 20px;
}

input, textarea {
    width: 100%;
    padding: 10px;
    font-size: 1rem;
    margin: 5px 0;
}
/* Sidebar Navigation */
nav {
    background-color: #800000; /* Warna merah maroon */
    padding: 20px;
    text-align: center;
}

nav ul {
    list-style-type: none;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
}

nav ul li {
    margin: 5px 15px;
}

nav ul li a {
    text-decoration: none;
    font-size: 1.2rem;
    color: #ffffff; /* Mengubah warna teks menjadi putih untuk kontras yang lebih baik */
    white-space: nowrap;
}

/* Responsive Styles */
@media (max-width: 768px) {
    .filter-container {
        flex-direction: column;
    }

    nav ul {
        flex-direction: column;
    }

    .attendance-info {
        flex-direction: column;
    }
    
    .attendance-item {
        width: 100%;
        margin: 5px 0;
    }
}

@media (max-width: 576px) {
    table, thead, tbody, th, td, tr {
        display: block;
    }

    thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
    }

    tr {
        margin-bottom: 10px;
    }

    td {
        border: none;
        position: relative;
        padding-left: 50%;
        text-align: right;
    }

    td:before {
        content: attr(data-label);
        position: absolute;
        left: 6px;
        width: 45%;
        padding-right: 10px;
        white-space: nowrap;
        text-align: left;
        font-weight: bold;
    }
}
/* Section Styling */
#monitoringOrangTua {
  padding: 20px;
  background-color: #f9f9f9;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  margin-top: 20px;
}

#monitoringOrangTua h2 {
  font-size: 24px;
  color: #333;
  margin-bottom: 15px;
  text-align: center;
}

/* Input Field and Button */
#monitoringOrangTua input[type="text"] {
  padding: 10px;
  width: 80%;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin-right: auto;
  margin-left: auto;
  display: block;
  box-sizing: border-box;
}

#monitoringOrangTua button {
  padding: 8px;
  font-size: 14px;
  color: #fff;
  background: #007bff;
  border: 0;
  border-radius: 4px;
  cursor: pointer;
}

#monitoringOrangTua button:hover {
  background-color: #0056b3;
}

/* Student Info & Message */
#studentInfo {
  margin-top: 20px;
  padding: 15px;
  background-color: #e9ecef;
  border-radius: 4px;
  font-size: 16px;
  color: #333;
}

#attendanceMessage {
  margin-top: 20px;
  padding: 15px;
  background-color: #f5f5f5;
  border-radius: 4px;
}

#attendanceMessage h3 {
  font-size: 18px;
  color: #555;
}

#attendanceMessage p {
  font-size: 16px;
  color: #666;
}

/* Parent Note */
#parentNote {
  margin-top: 20px;
  padding: 15px;
  background-color: #fff5e6;
  border: 1px solid #ffcc99;
  border-radius: 4px;
  font-size: 16px;
  color: #663300;
}

/* Absensi Harian */
#absensiHarian {
    background-color: #f9f9f9;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

#absensiHarian h2 {
    color: #007BFF;
    margin-bottom: 20px;
}

#absensiHarian #currentDate {
    font-weight: bold;
    color: #333;
}

#absensiTable {
    margin-top: 20px;
}

#absensiTable th {
    background-color: #007BFF;
    color: white;
}

#absensiTable td {
    vertical-align: middle;
}

/* Rekap Absensi */
#rekapAbsensi {
  background-color: #f0f8ff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

#rekapAbsensi h2 {
  color: #0056b3;
  margin-bottom: 20px;
}

#monthSelect {
  margin-bottom: 20px;
  padding: 5px;
  border-radius: 5px;
}

.table-responsive {
  overflow-x: auto;
  max-width: 100%;
}

#rekapTable {
  border-collapse: separate;
  border-spacing: 0;
  width: auto;
  min-width: 100%;
}

#rekapTable th, #rekapTable td {
  border: 1px solid #ddd;
  padding: 8px;
  white-space: nowrap;
}

#rekapTable th {
  background-color: #0056b3;
  color: white;
  position: sticky;
  top: 0;
  z-index: 10;
}

.sunday-header, .sunday {
  background-color: #6d0c1b;
}

.sticky-col {
  position: sticky;
  left: 0;
  background-color: #fff;
  z-index: 20;
}

#rekapTable th.sticky-col,
#rekapTable td.sticky-col {
  border-right: 2px solid #ddd;
}

#rekapTable th.sticky-col {
  z-index: 30;
}

/* Warna untuk status kehadiran */
.hadir { background-color: #90EE90; } /* Hijau muda */
.sakit { background-color: #ADD8E6; } /* Biru muda */
.izin { background-color: #FFFFE0; } /* Kuning muda */
.alpha { background-color: #FFB6C1; } /* Merah muda */

/* Catatan Guru */
#catatanGuru {
    background-color: #fff3e0;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

#catatanGuru h2 {
    color: #FF9800;
    margin-bottom: 20px;
}

.autocomplete-list {
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 0 0 5px 5px;
    max-height: 200px;
    overflow-y: auto;
}

.autocomplete-list li {
    padding: 10px;
    cursor: pointer;
}

.autocomplete-list li:hover {
    background-color: #f1f1f1;
}

/* Edit Kehadiran */
#editKehadiran {
    background-color: #e3f2fd;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

#editKehadiran h2 {
    color: #2196F3;
    margin-bottom: 20px;
}

#editDate {
    margin-bottom: 20px;
    padding: 5px;
    border-radius: 5px;
}

#editTable {
    margin-top: 20px;
}

#editTable th {
    background-color: #2196F3;
    color: white;
}

/* Tombol */
button {
    margin-top: 10px;
    transition: background-color 0.3s;
}

button:hover {
    opacity: 0.9;
}

/* Responsif */
@media (max-width: 768px) {
    .attendance-info {
        flex-direction: column;
    }
    
    .attendance-item {
        width: 100%;
        margin: 5px 0;
    }
}

/* Navigasi Kustom */
.custom-nav {
  background-color: #800000 !important; /* Merah maroon dengan !important */
  padding: 15px 0;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.custom-nav ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
}

.custom-nav ul li {
  margin: 5px 10px;
}

.custom-nav ul li a {
  text-decoration: none;
  color: #ffffff !important; /* Putih dengan !important */
  font-weight: bold;
  padding: 8px 15px;
  border-radius: 20px;
  transition: all 0.3s ease;
}

.custom-nav ul li a:hover {
  background-color: #ffffff;
  color: #800000 !important; /* Merah maroon saat hover dengan !important */
}

@media (max-width: 768px) {
  .custom-nav ul {
    flex-direction: column;
    align-items: center;
  }

  .custom-nav ul li {
    margin: 5px 0;
  }
}

/* Gaya umum */
body {
  font-family: 'Amiri', serif; /* Font islami */
  background-color: #f8f3e6; /* Warna latar belakang krem lembut */
  color: #3c3c3c;
}

/* Header */
header {
  background-color: #930b0b; /* Warna biru tua */
  padding: 20px 0;
  text-align: center;
}

header h1 {
  color: #fff;
  font-size: 2.5em;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
  margin: 0;
}

/* Filter container */
.filter-container {
  background-color: #fff;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  margin-bottom: 30px;
}

.row {
  display: flex;
  flex-wrap: wrap;
  margin-right: -15px;
  margin-left: -15px;
}

.col-md-6 {
  position: relative;
  width: 100%;
  padding-right: 15px;
  padding-left: 15px;
}

@media (min-width: 768px) {
  .col-md-6 {
    flex: 0 0 50%;
    max-width: 50%;
  }
  
  .mb-md-0 {
    margin-bottom: 0 !important;
  }
}

.awesome-select {
  width: 100%;
  padding: 10px;
  font-size: 1rem;
  border: 2px solid #1c4e80;
  border-radius: 5px;
  background-color: #f0f0f0;
  color: #3c3c3c;
  transition: all 0.3s ease;
}

.awesome-select:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(28, 78, 128, 0.3);
}

/* Tombol */
button {
  background-color: #1c4e80;
  color: #fff;
  border: none;
  padding: 12px 20px;
  border-radius: 5px;
  font-size: 1em;
  cursor: pointer;
  transition: all 0.3s ease;
}

button:hover {
  background-color: #153a5f;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

/* Tabel */
table {
  background-color: #fff;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

th {
  background-color: #1c4e80;
  color: #fff;
  padding: 15px;
}

td {
  padding: 12px;
  border-bottom: 1px solid #e0e0e0;
}

tr:last-child td {
  border-bottom: none;
}

/* Efek hover pada baris tabel */
tr:hover {
  background-color: #f5f5f5;
}

/* Responsif */
@media (max-width: 768px) {
  .main-title {
    font-size: 1.8em;
    padding: 10px 20px;
  }

  .awesome-select, button {
    width: 100%;
    margin-bottom: 10px;
  }
}

.filter-container {
  background-color: #fff;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  margin-bottom: 30px;
}

.filter-row {
  display: flex;
  justify-content: space-between;
  gap: 20px;
}

.filter-column {
  flex: 1;
}

.awesome-select {
  width: 100%;
  padding: 10px;
  font-size: 1rem;
  border: 2px solid #1c4e80;
  border-radius: 5px;
  background-color: #f0f0f0;
  color: #3c3c3c;
  transition: all 0.3s ease;
}

.awesome-select:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(28, 78, 128, 0.3);
}

@media (max-width: 768px) {
  .filter-row {
    flex-direction: column;
  }
}

/* Styling untuk Monitoring Orang Tua */
#monitoringOrangTua {
  background-color: #f8f9fa;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  padding: 30px;
  margin-top: 40px;
}

#monitoringOrangTua h2 {
  color: #2c3e50;
  font-size: 2.5rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 30px;
  text-transform: uppercase;
  letter-spacing: 2px;
  border-bottom: 3px solid #3498db;
  padding-bottom: 15px;
}

#noinfaqInput {
  width: 100%;
  padding: 15px;
  font-size: 1.1rem;
  border: 2px solid #3498db;
  border-radius: 8px;
  margin-bottom: 20px;
  transition: all 0.3s ease;
}

#noinfaqInput:focus {
  outline: none;
  box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
}

#monitoringOrangTua button {
  background-color: #3498db;
  color: white;
  border: none;
  padding: 15px 30px;
  font-size: 1.1rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: block;
  margin: 0 auto;
  width: auto;
}

#monitoringOrangTua button:hover {
  background-color: #2980b9;
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(41, 128, 185, 0.4);
}

#studentInfo, #attendanceMessage, #parentNote {
  background-color: white;
  border-radius: 10px;
  padding: 20px;
  margin-top: 30px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
}

#studentInfo h3, #attendanceMessage h3 {
  color: #2c3e50;
  font-size: 1.8rem;
  margin-bottom: 20px;
  border-left: 5px solid #3498db;
  padding-left: 15px;
}

.attendance-info {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  margin-top: 20px;
}

.attendance-item {
  flex-basis: 22%;
  text-align: center;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}

.attendance-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.attendance-item .count {
  font-size: 2.5rem;
  font-weight: bold;
  color: #3498db;
}

.attendance-item .label {
  font-size: 1.1rem;
  color: #7f8c8d;
  margin-top: 5px;
}

#messageContent {
  font-size: 1.1rem;
  line-height: 1.6;
  color: #34495e;
}

#parentNote {
  background-color: #ecf0f1;
}

#parentNote h3 {
  color: #e74c3c;
  border-left: 5px solid #e74c3c;
}

.note-card {
  background-color: white;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
}

.note-date {
  font-size: 0.9rem;
  color: #7f8c8d;
  margin-bottom: 5px;
}

@media (max-width: 768px) {
  .attendance-item {
    flex-basis: 48%;
    margin-bottom: 15px;
  }
}

@media (max-width: 480px) {
  .attendance-item {
    flex-basis: 100%;
  }
}

/* Perbaikan untuk tampilan tabel di layar kecil */
@media (max-width: 768px) {
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    position: relative;
  }

  table {
    width: 100%;
    table-layout: fixed;
  }

  th, td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    padding: 8px;
  }

  .sticky-col {
    position: sticky;
    left: 0;
    z-index: 2;
    background-color: #fff;
  }

  .sticky-col:after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 10px;
    background: linear-gradient(to right, rgba(0,0,0,0.1), rgba(0,0,0,0));
  }

  /* Atur lebar kolom */
  th:nth-child(1), td:nth-child(1) { width: 40px; }
  th:nth-child(2), td:nth-child(2) { width: 120px; }
  th:nth-child(n+3), td:nth-child(n+3) { width: 60px; }
}
</style>
</head>
<body>
  <header>
    <h1>Rumah Tahfidz Saijaan</h1>
  </header>
  
  <div class="filter-container mb-3">
    <div class="filter-row">
      <div class="filter-column">
        <select id="pembimbingFilter" class="form-select awesome-select">
          <option value="">Pilih Pembimbing</option>
        </select>
      </div>
      <div class="filter-column">
        <select id="statusFilter" class="form-select awesome-select" disabled>
          <option value="">Pilih Kelas</option>
        </select>
      </div>
    </div>
  </div>

  <nav class="custom-nav" style="display: none;">
    <ul>
      <li><a href="#" onclick="showSection('absensiHarian')">Absensi Harian</a></li>
      <li><a href="#" onclick="showSection('rekapAbsensi')">Rekap Absensi</a></li>
      <li><a href="#" onclick="showSection('monitoringOrangTua')">Monitoring Orang Tua</a></li>
      <li><a href="#" onclick="showSection('catatanGuru')">Catatan Pembimbing</a></li>
      <li><a href="#" onclick="showSection('editKehadiran')">Edit Kehadiran</a></li>
    </ul>
  </nav>

  
  <div class="container">
    <section id="absensiHarian">
      <h2>Absensi Harian</h2>
      <p><span id="currentDate"></span></p>
      <div class="table-responsive">
      <table id="absensiTable">
        <thead>
          <tr>
            <th class="sticky-col">No.</th>
            <th class="sticky-col">Nama</th>
            <th>Hadir</th>
            <th>Sakit</th>
            <th>Izin</th>
            <th>Alpha</th>
          </tr>
        </thead>
        <tbody id="absensiBody"></tbody>
      </table>
      </div>
      <button onclick="simpanAbsensi()">Simpan Absensi</button>
    </section>

    <section id="rekapAbsensi" class="hidden">
      <h2>Rekap Absensi</h2>
      <select id="monthSelect" onchange="updateRekapAbsensi()">
        <option value="0">Januari</option>
        <option value="1">Februari</option>
        <option value="2">Maret</option>
        <option value="3">April</option>
        <option value="4">Mei</option>
        <option value="5">Juni</option>
        <option value="6">Juli</option>
        <option value="7">Agustus</option>
        <option value="8">September</option>
        <option value="9">Oktober</option>
        <option value="10">November</option>
        <option value="11">Desember</option>
      </select>
      <div class="table-responsive">
        <table id="rekapTable">
          <thead id="rekapHead"></thead>
          <tbody id="rekapBody"></tbody>
        </table>
      </div>
      <button id="downloadExcelBtn" onclick="downloadExcel()">Download Excel</button>
    </section>

    <section id="monitoringOrangTua">
      <h2>Monitoring Orang Tua</h2>
      <div>
        <div>
          <div>
            <input type="text" id="noinfaqInput" placeholder="Masukkan No. Infaq">
            <button onclick="searchStudent()" style="width: auto; padding: 8px 40px; display: block; margin: 0 auto;">Cari</button>
          </div>
        </div>
      </div>
      <div id="studentInfo"></div>
      <div id="attendanceMessage">
        <h3>Pemberitahuan Kehadiran</h3>
        <p id="messageContent"></p>
      </div>
      <div id="parentNote"></div>
    </section>

    <section id="catatanGuru" class="hidden">
      <h2>Catatan Pembimbing</h2>
      <div class="form-group">
        <label for="studentSearch">Cari Santri:</label>
        <input type="text" id="studentSearch" placeholder="Ketik nama santri">
        <ul id="studentList" class="autocomplete-list"></ul>
      </div>
      <div class="form-group">
        <label for="noteInput">Catatan:</label>
        <textarea id="noteInput" rows="4" cols="50"></textarea>
      </div>
      <button onclick="saveNote()">Simpan Catatan</button>
      <div id="noteList"></div>
    </section>

    <section id="editKehadiran" class="hidden">
      <h2>Edit Kehadiran</h2>
      <div class="form-group">
        <label for="editDate">Pilih Tanggal:</label>
        <input type="date" id="editDate">
      </div>
      <button onclick="loadAttendanceForEdit()">Muat Data</button>
      <table id="editTable" class="hidden">
        <thead>
          <tr>
            <th>No.</th>
            <th>Nama</th>
            <th>Hadir</th>
            <th>Sakit</th>
            <th>Izin</th>
            <th>Alpha</th>
          </tr>
        </thead>
        <tbody id="editBody"></tbody>
      </table>
      <button onclick="saveEditedAttendance()" class="hidden" id="saveEditBtn">Simpan Perubahan</button>
      <button onclick="downloadAttendanceData()" class="hidden" id="downloadDataBtn">Unduh Data Kehadiran</button>
    </section>
  </div>
<script src="js/script2.js"></script>
  <script>

    let dailyAttendance = {};
    let studentNotes = {};

    function initializeFilters() {
      const pembimbingFilter = document.getElementById('pembimbingFilter');
      const statusFilter = document.getElementById('statusFilter');
      const uniquePembimbings = [...new Set(data.map(item => item['PEMBIMBING BARU']))];
      
      uniquePembimbings.forEach(pembimbing => {
        const option = document.createElement('option');
        option.value = pembimbing;
        option.textContent = pembimbing;
        pembimbingFilter.appendChild(option);
      });

      pembimbingFilter.addEventListener('change', function() {
        statusFilter.disabled = !this.value;
        statusFilter.innerHTML = '<option value="">Pilih Kelas</option>';
        if (this.value) {
          const filteredData = data.filter(item => item['PEMBIMBING BARU'] === this.value);
          const uniqueStatuses = [...new Set(filteredData.map(item => item.STATUS))];
          uniqueStatuses.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            statusFilter.appendChild(option);
          });
        }
      });

      statusFilter.addEventListener('change', function() {
        if (this.value) {
          document.querySelector('nav').style.display = 'block';
          showSection('absensiHarian');
        }
      });
    }

    function showSection(sectionId) {
      document.querySelectorAll('section').forEach(section => {
        section.classList.add('hidden');
      });
      document.getElementById(sectionId).classList.remove('hidden');
      if (sectionId === 'absensiHarian') {
        initializeAbsensiHarian();
      } else if (sectionId === 'rekapAbsensi') {
        updateRekapAbsensi();
      } else if (sectionId === 'catatanGuru') {
        initializeCatatanGuru();
      }
    }

    function initializeAbsensiHarian() {
      const currentDate = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const formattedDate = currentDate.toLocaleDateString('id-ID', options);
      document.getElementById('currentDate').textContent = formattedDate;
      const absensiBody = document.getElementById('absensiBody');
      absensiBody.innerHTML = '';
      
      const pembimbing = document.getElementById('pembimbingFilter').value;
      const status = document.getElementById('statusFilter').value;
      const filteredData = data.filter(item => item['PEMBIMBING BARU'] === pembimbing && item.STATUS === status);
      
      filteredData.forEach((student, index) => {
        const row = document.createElement('tr');
        const isSunday = new Date().getDay() === 0;
        const savedAttendance = localStorage.getItem(`attendance_${student.NOINFAQ}_${currentDate}`);
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${student.NAMA}</td>
          <td><input type="radio" name="attendance_${student.NOINFAQ}" value="hadir" ${savedAttendance === 'hadir' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="attendance_${student.NOINFAQ}" value="sakit" ${savedAttendance === 'sakit' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="attendance_${student.NOINFAQ}" value="izin" ${savedAttendance === 'izin' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="attendance_${student.NOINFAQ}" value="alpha" ${savedAttendance === 'alpha' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
        `;
        if (student.STATUS === 'TAHFIDZ') {
          row.classList.add('status-tahfidz');
        }
        if (isSunday) {
          row.classList.add('disabled');
        }
        absensiBody.appendChild(row);

        // Tambahkan event listener untuk menyimpan status kehadiran ke localStorage
        const radioButtons = row.querySelectorAll('input[type="radio"]');
        radioButtons.forEach(radio => {
          radio.addEventListener('change', function() {
            localStorage.setItem(`attendance_${student.NOINFAQ}_${currentDate}`, this.value);
          });
        });
      });
    }

    function simpanAbsensi() {
      const currentDate = new Date().toISOString().split('T')[0];
      const absensiData = {};
      data.forEach(student => {
        const attendance = document.querySelector(`input[name="attendance_${student.NOINFAQ}"]:checked`);
        if (attendance) {
          absensiData[student.NOINFAQ] = attendance.value;
        }
      });
      
      db.collection('dailyAttendance').doc(currentDate).set(absensiData)
        .then(() => {
          alert('Absensi berhasil disimpan!');
          dailyAttendance[currentDate] = absensiData; // Perbarui data lokal
          updateRekapAbsensi(); // Perbarui tampilan
        })
        .catch((error) => {
          console.error("Error writing document: ", error);
          alert('Terjadi kesalahan saat menyimpan absensi.');
        });
    }

    function updateRekapAbsensi() {
      const month = document.getElementById('monthSelect').value;
      const year = new Date().getFullYear();
      const daysInMonth = new Date(year, parseInt(month) + 1, 0).getDate();
      
      const rekapHead = document.getElementById('rekapHead');
      const rekapBody = document.getElementById('rekapBody');

      const pembimbing = document.getElementById('pembimbingFilter').value;
      const status = document.getElementById('statusFilter').value;
      const filteredData = data.filter(item => item['PEMBIMBING BARU'] === pembimbing && item.STATUS === status);

      let headerRow = '<tr><th class="sticky-col">No</th><th class="sticky-col">Nama</th>';
      for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(year, parseInt(month), i);
        const isSunday = date.getDay() === 0;
        headerRow += `<th class="${isSunday ? 'sunday-header' : ''}">${i}</th>`;
      }
      headerRow += '</tr>';
      rekapHead.innerHTML = headerRow;
      
      rekapBody.innerHTML = '';
      filteredData.forEach((student, index) => {
        let row = `<tr><td class="sticky-col">${index + 1}</td><td class="sticky-col">${student.NAMA}</td>`;
        for (let i = 1; i <= daysInMonth; i++) {
          const date = `${year}-${(parseInt(month) + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
          const isSunday = new Date(date).getDay() === 0;
          const attendanceStatus = dailyAttendance[date] && dailyAttendance[date][student.NOINFAQ] ? dailyAttendance[date][student.NOINFAQ] : '';
          row += `<td class="${isSunday ? 'sunday' : ''} ${attendanceStatus}">${isSunday ? '-' : (attendanceStatus.charAt(0).toUpperCase() || '-')}</td>`;
        }
        row += '</tr>';
        rekapBody.innerHTML += row;
      });

      // Menyimpan rekap absensi ke Firestore
      const rekapData = {
        month: parseInt(month) + 1,
        year: year,
        pembimbing: pembimbing,
        status: status,
        data: filteredData.map(student => {
          let attendanceData = {};
          for (let i = 1; i <= daysInMonth; i++) {
            const date = `${year}-${(parseInt(month) + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
            attendanceData[i] = dailyAttendance[date] && dailyAttendance[date][student.NOINFAQ] ? dailyAttendance[date][student.NOINFAQ] : '';
          }
          return {
            noinfaq: student.NOINFAQ,
            nama: student.NAMA,
            attendance: attendanceData
          };
        })
      };

      db.collection('rekapAbsensi').doc(`${year}-${parseInt(month) + 1}-${pembimbing}-${status}`)
        .set(rekapData)
        .then(() => {
          console.log('Rekap absensi berhasil disimpan ke Firestore');
        })
        .catch((error) => {
          console.error('Error menyimpan rekap absensi:', error);
        });
    }

    function downloadExcel() {
      const month = document.getElementById('monthSelect').value;
      const year = new Date().getFullYear();
      const pembimbing = document.getElementById('pembimbingFilter').value;
      const status = document.getElementById('statusFilter').value;

      // Membuat workbook dan worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(document.getElementById('rekapTable'));

      // Mengatur nama file
      const fileName = `Rekap_Absensi_${pembimbing}_${status}_${year}_${parseInt(month) + 1}.xlsx`;

      // Menambahkan worksheet ke workbook
      XLSX.utils.book_append_sheet(wb, ws, "Rekap Absensi");

      // Mengunduh file Excel
      XLSX.writeFile(wb, fileName);
    }

    function searchStudent() {
      const noinfaq = document.getElementById('noinfaqInput').value;
      const student = data.find(s => s.NOINFAQ === noinfaq);
      const studentInfo = document.getElementById('studentInfo');
      const parentNote = document.getElementById('parentNote');
      const attendanceMessage = document.getElementById('attendanceMessage');
      const messageContent = document.getElementById('messageContent');
      
      if (student) {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        let attendanceSummary = { hadir: 0, sakit: 0, izin: 0, alpha: 0 };
        let attendanceDates = { sakit: [], izin: [], alpha: [] };
        
        Object.entries(dailyAttendance).forEach(([date, day]) => {
          const attendanceDate = new Date(date);
          if (attendanceDate.getMonth() === currentMonth && attendanceDate.getFullYear() === currentYear) {
            if (day[noinfaq]) {
              attendanceSummary[day[noinfaq]]++;
              if (['sakit', 'izin', 'alpha'].includes(day[noinfaq])) {
                attendanceDates[day[noinfaq]].push(attendanceDate);
              }
            }
          }
        });
        
        let attendanceHtml = '';
        ['hadir', 'sakit', 'izin', 'alpha'].forEach(status => {
          attendanceHtml += `
            <div class="attendance-item">
              <div class="count">${attendanceSummary[status]}</div>
              <div class="label">${status.charAt(0).toUpperCase() + status.slice(1)}</div>
              ${status !== 'hadir' ? `<div class="dates">Tanggal: ${attendanceDates[status].map(d => d.toLocaleDateString('id-ID')).join(', ')}</div>` : ''}
            </div>
          `;
        });
        
        studentInfo.innerHTML = `
          <div class="card">
            <h3>${student.NAMA}</h3>
            <p><strong>No. Infaq:</strong> ${student.NOINFAQ}</p>
            <p><strong>Pembimbing:</strong> ${student["PEMBIMBING BARU"]}</p>
            <p><strong>Kelas:</strong> ${student.STATUS}</p>
            <h4>Ringkasan Kehadiran Bulan Ini:</h4>
            <div class="attendance-info">
              ${attendanceHtml}
            </div>
          </div>
        `;
        
        // Membuat pesan otomatis
        let message = '';
        ['sakit', 'izin', 'alpha'].forEach(status => {
          if (attendanceDates[status].length > 0) {
            message += `Ananda tidak hadir karena ${status} pada tanggal: ${attendanceDates[status].map(d => d.toLocaleDateString('id-ID')).join(', ')}.\n`;
          }
        });
        
        if (message) {
          messageContent.innerHTML = `
            <p>Yth. Orang Tua/Wali dari ${student.NAMA},</p>
            <p>Kami ingin memberitahukan bahwa:</p>
            <p>${message}</p>
            <p>Total kehadiran bulan ini:</p>
            <ul>
              <li>Hadir: ${attendanceSummary.hadir} hari</li>
              <li>Sakit: ${attendanceSummary.sakit} hari</li>
              <li>Izin: ${attendanceSummary.izin} hari</li>
              <li>Alpha: ${attendanceSummary.alpha} hari</li>
            </ul>
            <p>Hormat kami,<br>Rumah Tahfidz Saijaan</p>
          `;
          attendanceMessage.classList.remove('hidden');
        } else {
          attendanceMessage.classList.add('hidden');
        }
        
        const notes = studentNotes[noinfaq] || [];
        parentNote.innerHTML = `
          <div class="card">
            <h3>Catatan Guru:</h3>
            ${notes.length > 0 ? notes.map(note => `
              <div class="note-card">
                <div class="note-date">${new Date(note.date).toLocaleString('id-ID')}</div>
                <div>${note.note}</div>
              </div>
            `).join('') : '<p>Belum ada catatan.</p>'}
          </div>
        `;

        // Menyimpan data monitoring ke Firestore
        const monitoringData = {
          noinfaq: student.NOINFAQ,
          nama: student.NAMA,
          pembimbing: student["PEMBIMBING BARU"],
          kelas: student.STATUS,
          attendanceSummary: attendanceSummary,
          attendanceDates: attendanceDates,
          lastChecked: new Date().toISOString()
        };

        db.collection('monitoringOrangTua').doc(student.NOINFAQ)
          .set(monitoringData)
          .then(() => {
            console.log('Data monitoring berhasil disimpan ke Firestore');
          })
          .catch((error) => {
            console.error('Error menyimpan data monitoring:', error);
          });
      } else {
        studentInfo.innerHTML = '<div class="card"><p>Siswa tidak ditemukan.</p></div>';
        parentNote.innerHTML = '';
        attendanceMessage.classList.add('hidden');
      }
    }

    function initializeCatatanGuru() {
      const studentSearch = document.getElementById('studentSearch');
      const studentList = document.getElementById('studentList');

      studentSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredStudents = data.filter(student => 
          student.NAMA.toLowerCase().includes(searchTerm)
        );

        studentList.innerHTML = '';
        studentList.style.display = filteredStudents.length > 0 ? 'block' : 'none';

        filteredStudents.forEach(student => {
          const li = document.createElement('li');
          li.textContent = student.NAMA;
          li.onclick = function() {
            studentSearch.value = student.NAMA;
            studentList.style.display = 'none';
            updateNoteList(student.NOINFAQ);
          };
          studentList.appendChild(li);
        });
      });

      updateNoteList();
    }

    function saveNote() {
      const studentName = document.getElementById('studentSearch').value;
      const student = data.find(s => s.NAMA === studentName);
      if (!student) {
        alert('Silakan pilih siswa terlebih dahulu.');
        return;
      }

      const note = document.getElementById('noteInput').value;
      const noteData = {
        date: new Date().toISOString(),
        note: note
      };

      // Simpan catatan ke Firebase
      db.collection('studentNotes').doc(student.NOINFAQ).collection('notes').add(noteData)
        .then(() => {
          if (!studentNotes[student.NOINFAQ]) {
            studentNotes[student.NOINFAQ] = [];
          }
          studentNotes[student.NOINFAQ].push(noteData);
          document.getElementById('noteInput').value = '';
          updateNoteList(student.NOINFAQ);
          alert('Catatan berhasil disimpan!');
        })
        .catch((error) => {
          console.error("Error saving note: ", error);
          alert('Terjadi kesalahan saat menyimpan catatan.');
        });
    }

    function updateNoteList(noinfaq) {
      const noteList = document.getElementById('noteList');
      if (!noinfaq) {
        noteList.innerHTML = '<p>Pilih siswa untuk melihat catatan.</p>';
        return;
      }

      // Ambil catatan dari Firebase
      db.collection('studentNotes').doc(noinfaq).collection('notes')
        .orderBy('date', 'desc')
        .limit(5)
        .get()
        .then((querySnapshot) => {
          noteList.innerHTML = '<h4>Catatan Terbaru:</h4>';
          querySnapshot.forEach((doc) => {
            const note = doc.data();
            noteList.innerHTML += `<p>${new Date(note.date).toLocaleString()}: ${note.note}</p>`;
          });
        })
        .catch((error) => {
          console.error("Error getting notes: ", error);
          noteList.innerHTML = '<p>Terjadi kesalahan saat mengambil catatan.</p>';
        });
    }

    function loadAttendanceForEdit() {
      const editDate = document.getElementById('editDate').value;
      const editBody = document.getElementById('editBody');
      editBody.innerHTML = '';
      
      const pembimbing = document.getElementById('pembimbingFilter').value;
      const status = document.getElementById('statusFilter').value;
      const filteredData = data.filter(item => item['PEMBIMBING BARU'] === pembimbing && item.STATUS === status);
      
      filteredData.forEach((student, index) => {
        const row = document.createElement('tr');
        const attendance = dailyAttendance[editDate] ? dailyAttendance[editDate][student.NOINFAQ] : '';
        const isSunday = new Date(editDate).getDay() === 0;
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${student.NAMA}</td>
          <td><input type="radio" name="edit_attendance_${student.NOINFAQ}" value="hadir" ${attendance === 'hadir' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="edit_attendance_${student.NOINFAQ}" value="sakit" ${attendance === 'sakit' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="edit_attendance_${student.NOINFAQ}" value="izin" ${attendance === 'izin' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
          <td><input type="radio" name="edit_attendance_${student.NOINFAQ}" value="alpha" ${attendance === 'alpha' ? 'checked' : ''} ${isSunday ? 'disabled' : ''}></td>
        `;
        if (isSunday) {
          row.classList.add('disabled');
        }
        editBody.appendChild(row);
      });
      
      document.getElementById('editTable').classList.remove('hidden');
      document.getElementById('saveEditBtn').classList.remove('hidden');
      document.getElementById('downloadDataBtn').classList.remove('hidden');
    }

    function saveEditedAttendance() {
      const editDate = document.getElementById('editDate').value;
      const editedData = {};
      
      data.forEach(student => {
        const attendance = document.querySelector(`input[name="edit_attendance_${student.NOINFAQ}"]:checked`);
        if (attendance) {
          editedData[student.NOINFAQ] = attendance.value;
        }
      });
      
      db.collection('dailyAttendance').doc(editDate).set(editedData)
        .then(() => {
          alert('Perubahan absensi berhasil disimpan!');
          dailyAttendance[editDate] = editedData; // Perbarui data lokal
          updateRekapAbsensi(); // Perbarui tampilan
        })
        .catch((error) => {
          console.error("Error updating document: ", error);
          alert('Terjadi kesalahan saat menyimpan perubahan absensi.');
        });
    }

    function downloadAttendanceData() {
      db.collection('dailyAttendance').get()
        .then((querySnapshot) => {
          const attendanceData = {};
          querySnapshot.forEach((doc) => {
            attendanceData[doc.id] = doc.data();
          });
          
          const wb = XLSX.utils.book_new();
          const wsData = Object.entries(attendanceData).flatMap(([date, attendance]) => 
            Object.entries(attendance).map(([noinfaq, status]) => ({
              Tanggal: date,
              'No. Infaq': noinfaq,
              Nama: data.find(s => s.NOINFAQ === noinfaq)?.NAMA || '',
              Status: status
            }))
          );
          const ws = XLSX.utils.json_to_sheet(wsData);

          XLSX.utils.book_append_sheet(wb, ws, "Data Kehadiran");
          XLSX.writeFile(wb, "Data_Kehadiran.xlsx");
        })
        .catch((error) => {
          console.error("Error downloading attendance data: ", error);
          alert("Terjadi kesalahan saat mengunduh data kehadiran.");
        });
    }

    // Fungsi untuk memuat data kehadiran dari Firestore
    function loadAttendanceData() {
      db.collection('dailyAttendance').get()
        .then((querySnapshot) => {
          dailyAttendance = {};
          querySnapshot.forEach((doc) => {
            dailyAttendance[doc.id] = doc.data();
          });
          console.log('Data kehadiran berhasil dimuat');
          updateRekapAbsensi(); // Memperbarui tampilan setelah data dimuat
        })
        .catch((error) => {
          console.error("Error loading attendance data: ", error);
        });
    }

    // Panggil fungsi loadAttendanceData saat halaman dimuat
    document.addEventListener('DOMContentLoaded', loadAttendanceData);

    // Initialize the page
    initializeFilters();
    showSection('absensiHarian');
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    // Konfigurasi Firebase Anda
       // Konfigurasi Firebase Anda
       const firebaseConfig = {
      apiKey: "AIzaSyB4xPZNU7xb8mXR85gcR9HfLmfHmZeb_zI",
      authDomain: "inputsiswa-1af9a.firebaseapp.com",
      projectId: "inputsiswa-1af9a",
      storageBucket: "inputsiswa-1af9a.appspot.com",
      messagingSenderId: "706431942569",
      appId: "1:706431942569:web:3e36ac6a1d618617868eb8"
    };
    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    // Fungsi untuk mengatur bulan default
    function setDefaultMonth() {
      const currentMonth = new Date().getMonth();
      document.getElementById('monthSelect').value = currentMonth;
      updateRekapAbsensi();
    }

    // Panggil fungsi setDefaultMonth saat halaman dimuat
    window.onload = function() {
      setDefaultMonth();
      // ... kode lainnya yang perlu dijalankan saat halaman dimuat ...
    };
  </script>
</body>
</html>
