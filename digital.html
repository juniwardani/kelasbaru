<html><head><title>Sistem Absensi Digital</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: 'Arial', sans-serif;
    background-color: #f0f4f8;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }
  header {
    background-color: #2c3e50;
    color: white;
    text-align: center;
    padding: 20px 0;
    margin-bottom: 30px;
  }
  h1 {
    margin: 0;
    font-size: 2em;
  }
  .date-display {
    text-align: center;
    font-size: 1.2em;
    margin-bottom: 20px;
    font-weight: bold;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }
  th {
    background-color: #800000;
    color: white;
  }
  tr:nth-child(even) {
    background-color: #f2f2f2;
  }
  .status-select, .filter-select {
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ddd;
  }
  .btn {
    display: inline-block;
    padding: 10px 20px;
    font-size: 1em;
    text-align: center;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.1s;
  }
  .btn:active {
    transform: translateY(2px);
  }
  .submit-btn {
    background-color: #27ae60;
    color: white;
    margin-right: 10px;
  }
  .submit-btn:hover {
    background-color: #2ecc71;
  }
  .recap-btn {
    background-color: #3498db;
    color: white;
  }
  .recap-btn:hover {
    background-color: #2980b9;
  }
  .download-btn {
    background-color: #3498db;
    color: white;
  }
  .download-btn:hover {
    background-color: #2980b9;
  }
  .button-group {
    text-align: center;
    margin-top: 20px;
  }
  nav {
    background-color: #34495e;
    padding: 10px 0;
  }
  nav ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
    text-align: center;
  }
  nav ul li {
    display: inline;
    margin: 0 10px;
  }
  nav ul li a {
    color: white;
    text-decoration: none;
    font-size: 1.1em;
  }
  section {
    display: none;
  }
  section.active {
    display: block;
  }
  .edit-btn {
    background-color: #f39c12;
    color: white;
  }
  .edit-btn:hover {
    background-color: #e67e22;
  }
  .filter-container {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .filter-select {
    width: 48%;
  }
  #rekap-absen h2 {
    background-color: #2c3e50;
    color: white;
    padding: 15px;
    margin: 0 0 20px 0;
    text-align: center;
  }
  .rekap-controls {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  #monthSelector {
    padding: 8px;
    font-size: 16px;
  }
  .table-container {
    overflow-x: auto;
    max-height: 70vh;
    position: relative;
  }
  #rekapTable {
    border-collapse: separate;
    border-spacing: 0;
  }
  #rekapTable th, #rekapTable td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
    min-width: 40px;
  }
  #rekapTable th {
    background-color: #800000;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  #rekapTable .name-column {
    position: sticky;
    left: 0;
    background-color: #2c3e50;
    z-index: 5;
    color: white;
    text-align: center;
  }
  #rekapTable th.name-column {
    z-index: 15;
  }



  #input-absen h2 {
    background-color: #2c3e50;
    color: white;
    padding: 15px;
    margin: 0 0 20px 0;
    text-align: center;
  }


  #edit-kehadiran h2 {
    background-color: #2c3e50;
    color: white;
    padding: 15px;
    margin: 0 0 20px 0;
    text-align: center;
  }

  #editDateSelector {
    padding: 8px;
    font-size: 16px;
  }
  .status-cell {
  width: 40px; /* Ubah ukuran sesuai kebutuhan */
  height: 40px; /* Ubah ukuran sesuai kebutuhan */
  display: inline-block;
  /* Hapus border-radius untuk menghilangkan efek bulat */
  color: white;
  text-align: center;
  line-height: 40px; /* Sesuaikan dengan tinggi agar teks berada di tengah */
  font-weight: bold;
}

  .status-cell.hadir { background-color: #2ecc71; }
  .status-cell.izin { background-color: #f1c40f; }
  .status-cell.sakit { background-color: #3498db; }
  .status-cell.alpha { background-color: #e74c3c; }
  .sunday { background-color: #ffcccc; }
  .legend {
    display: flex;
    justify-content: center;
    gap: 20px;
  }
  .legend-item {
    display: flex;
    align-items: center;
  }
  .color-dot {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
  }
  @media (max-width: 768px) {
    .rekap-controls {
      flex-direction: column;
      align-items: stretch;
    }
    .rekap-controls > * {
      margin-bottom: 10px;
    }
  }
  .alert-success {
  padding: 15px;
  margin-bottom: 20px;
  border: 1px solid transparent;
  border-radius: 4px;
  background-color: #dff0d8;
  color: #3c763d;
  font-weight: bold;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
<script>
  // Fungsi untuk mendapatkan tanggal Indonesia saat ini
  function getCurrentIndonesiaDate() {
    const jakartaTime = new Date().toLocaleString("en-US", {timeZone: "Asia/Jakarta"});
    return new Date(jakartaTime);
  }

  // Fungsi untuk memformat tanggal menjadi YYYY-MM-DD
  function formatDateYYYYMMDD(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // Fungsi untuk memformat tanggal Indonesia
  function formatDateIndonesia(date) {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('id-ID', options);
  }

  // Ubah fungsi ini
  function updateCurrentDate() {
    const currentDate = getCurrentIndonesiaDate();
    document.querySelectorAll('.date-display').forEach(el => {
      el.textContent = formatDateIndonesia(currentDate);
    });
  }

  // Ubah fungsi ini
  function submitAttendance() {
    const filteredStudents = getFilteredStudents();
    const currentDate = getCurrentIndonesiaDate();
    const date = formatDateYYYYMMDD(currentDate);
    
    console.log("Menyimpan absensi untuk tanggal:", date);
    
    let successCount = 0;
    
    filteredStudents.forEach(student => {
      const statusElement = document.getElementById(`status-${student.id}`);
      if (statusElement && student.id && statusElement.value !== "") {
        const attendanceRecord = {
          date: date,
          nama: student.NAMA,
          status: statusElement.value
        };
        
        const localStorageKey = `attendance_${date}_${student.id}`;
        localStorage.setItem(localStorageKey, JSON.stringify(attendanceRecord));
        successCount++;
      }
    });

    alert(`Absensi berhasil disimpan untuk ${successCount} siswa pada tanggal ${formatDateIndonesia(currentDate)}!`);
    
    updateRekapTable(getFilteredStudents());
    showSection('rekap-absen');
  }

  // Ubah fungsi ini
  function updateRekapTable(filteredStudents) {
    const rekapList = document.getElementById('rekapList');
    rekapList.innerHTML = '';
    const month = parseInt(document.getElementById('monthSelector').value);
    const year = getCurrentIndonesiaDate().getFullYear();
    const daysInMonth = new Date(year, month, 0).getDate();

    const headerRow = document.getElementById('rekapHeader');
    headerRow.innerHTML = '<th class="name-column">No.</th><th class="name-column">Nama Siswa</th>';
    for (let i = 1; i <= daysInMonth; i++) {
      const th = document.createElement('th');
      const date = new Date(year, month - 1, i);
      th.textContent = i;
      if (date.getDay() === 0) { // Sunday
        th.classList.add('sunday');
      }
      headerRow.appendChild(th);
    }

    filteredStudents.forEach((student, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `<td class="name-column">${index + 1}</td><td class="name-column">${student.NAMA}</td>`;

      for (let i = 1; i <= daysInMonth; i++) {
        const td = document.createElement('td');
        const date = new Date(year, month - 1, i);
        const dateString = formatDateYYYYMMDD(date);
        
        if (date.getDay() === 0) { // Minggu
          td.classList.add('sunday');
        }
        
        if (student.id) {
          const cacheKey = `attendance_${dateString}_${student.id}`;
          const attendance = JSON.parse(localStorage.getItem(cacheKey));
          if (attendance) {
            updateCell(td, attendance);
          } else {
            td.innerHTML = '-';
          }
        } else {
          td.innerHTML = '-';
        }
        
        row.appendChild(td);
      }

      rekapList.appendChild(row);
    });

    populateEditKehadiran(filteredStudents);
  }

  // Panggil fungsi untuk memperbarui tanggal
  updateCurrentDate();

  // Tambahkan variabel untuk menyimpan cache
  let attendanceCache = {};

  function updateCell(td, attendance) {
    const statusText = {
      'hadir': 'H',
      'izin': 'I',
      'sakit': 'S',
      'alpha': 'A'
    }[attendance.status];
    td.innerHTML = `<span class="status-cell ${attendance.status}">${statusText}</span>`;
  }

  function saveEditedAttendance() {
    const selectedDate = document.getElementById('editDateSelector').value;
    const filteredStudents = getFilteredStudents();

    if (!selectedDate) {
      alert('Silakan pilih tanggal terlebih dahulu.');
      return;
    }

    let successCount = 0;

    filteredStudents.forEach(student => {
      const statusElement = document.getElementById(`edit-status-${student.id}`);
      if (statusElement && statusElement.value !== "") {
        const attendanceRecord = {
          date: selectedDate,
          nama: student.NAMA,
          status: statusElement.value
        };
        
        const localStorageKey = `attendance_${selectedDate}_${student.id}`;
        localStorage.setItem(localStorageKey, JSON.stringify(attendanceRecord));
        successCount++;
      } else {
        // Hapus data jika status kosong
        const localStorageKey = `attendance_${selectedDate}_${student.id}`;
        localStorage.removeItem(localStorageKey);
      }
    });

    alert(`Perubahan absensi berhasil disimpan untuk ${successCount} siswa!`);
    updateRekapTable(filteredStudents);
    showSection('rekap-absen');
  }

  function populateEditKehadiran(filteredStudents) {
    const editList = document.getElementById('editList');
    editList.innerHTML = '';
    const selectedDate = document.getElementById('editDateSelector').value;

    filteredStudents.forEach((student, index) => {
      const localStorageKey = `attendance_${selectedDate}_${student.id}`;
      const attendance = JSON.parse(localStorage.getItem(localStorageKey));
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${student.NAMA}</td>
        <td>
          <select class="status-select" id="edit-status-${student.id}">
            <option value="">Pilih status</option>
            <option value="hadir" ${attendance && attendance.status === 'hadir' ? 'selected' : ''}>Hadir</option>
            <option value="izin" ${attendance && attendance.status === 'izin' ? 'selected' : ''}>Izin</option>
            <option value="sakit" ${attendance && attendance.status === 'sakit' ? 'selected' : ''}>Sakit</option>
            <option value="alpha" ${attendance && attendance.status === 'alpha' ? 'selected' : ''}>Alpha</option>
          </select>
        </td>
      `;
      editList.appendChild(row);
    });
  }

  // Ganti fungsi ini
  function validateEditDate() {
    const selectedDate = document.getElementById('editDateSelector').value;
    const today = formatDateYYYYMMDD(getCurrentIndonesiaDate());
    
    if (selectedDate > today) {
      alert('Tidak dapat mengedit absensi untuk tanggal di masa depan.');
      document.getElementById('editDateSelector').value = today;
    }
  }

  // Tambahkan ini di akhir script atau di dalam event listener DOMContentLoaded
  document.addEventListener('DOMContentLoaded', (event) => {
    filterStudents();
    loadLastViewedSection();
    
    // Set nilai default untuk editDateSelector
    document.getElementById('editDateSelector').value = formatDateYYYYMMDD(getCurrentIndonesiaDate());
  });
</script>
</head>
<body>
  <header>
    <h1>Sistem Absensi Digital</h1>
  </header>
  
  <div class="container">
    <div class="filter-container">
      <select class="filter-select" id="pembimbingFilter" onchange="updateStatusFilter(); filterStudents(); checkFilters();">
        <option value="">Pilih Pembimbing</option>
        <!-- Pembimbing options will be dynamically added here -->
      </select>
      <select class="filter-select" id="kelasFilter" onchange="filterStudents(); checkFilters();">
        <option value="">Pilih Kelas</option>
        <!-- Kelas options will be dynamically added here -->
      </select>
    </div>
  </div>
  <script>
    function checkFilters() {
      const pembimbingFilter = document.getElementById('pembimbingFilter');
      const kelasFilter = document.getElementById('kelasFilter');
      const nav = document.querySelector('nav');
      
      if (pembimbingFilter.value !== "" && kelasFilter.value !== "") {
        nav.style.display = 'block';
      } else {
        nav.style.display = 'none';
      }
    }
    
    // Sembunyikan nav saat halaman dimuat
    document.addEventListener('DOMContentLoaded', function() {
      const nav = document.querySelector('nav');
      nav.style.display = 'none';
    });
  </script>
  
  <nav>
    <ul>
      <li><a href="#" onclick="showSection('input-absen')">Input Absen</a></li>
      <li><a href="#" onclick="showSection('rekap-absen')">Rekap Absen</a></li>
      <li><a href="#" onclick="showSection('edit-kehadiran')">Edit Kehadiran</a></li>
    </ul>
  </nav>

  <div class="container">
    <section id="input-absen">
      <h2>Absensi Harian</h2>
      <div class="date-display" id="currentDate"></div>
      
      <table>
        <thead>
          <tr>
            <th>No.</th>
            <th>Nama Siswa</th>
            <th>Kehadiran</th>
          </tr>
        </thead>
        <tbody id="studentList">
          <!-- Student rows will be dynamically added here -->
        </tbody>
      </table>
      
      <div class="button-group">
        <button class="btn submit-btn" onclick="submitAttendance()">Simpan Absensi</button>
      </div>
    </section>

    <section id="rekap-absen">
      <h2>Rekap Absensi Siswa</h2>
      
      <div class="rekap-controls">
        <select id="monthSelector">
          <option value="1">Januari</option>
          <option value="2">Februari</option>
          <option value="3">Maret</option>
          <option value="4">April</option>
          <option value="5">Mei</option>
          <option value="6">Juni</option>
          <option value="7">Juli</option>
          <option value="8">Agustus</option>
          <option value="9">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
          <option value="12">Desember</option>
        </select>
        <button id="downloadExcel" class="btn download-btn">Download Excel</button>
      </div>

      <div class="table-container">
        <table id="rekapTable">
          <thead>
            <tr id="rekapHeader">
              <th class="name-column">No.</th>
              <th class="name-column">Nama Siswa</th>
              <!-- Days will be dynamically added here -->
            </tr>
          </thead>
          <tbody id="rekapList">
            <!-- Recap rows will be dynamically added here -->
          </tbody>
        </table>
      </div>
      
      <div class="legend">
        <span class="legend-item"><span class="color-dot hadir"></span> Hadir</span>
        <span class="legend-item"><span class="color-dot izin"></span> Izin</span>
        <span class="legend-item"><span class="color-dot sakit"></span> Sakit</span>
        <span class="legend-item"><span class="color-dot alpha"></span> Alpha</span>
      </div>
    </section>

    <section id="edit-kehadiran">
      <h2>Edit Kehadiran</h2>
      <input type="date" id="editDateSelector" onchange="populateEditKehadiran(getFilteredStudents())" />
      
      <table>
        <thead>
          <tr>
            <th>No.</th>
            <th>Nama Siswa</th>
            <th>Kehadiran</th>
          </tr>
        </thead>
        <tbody id="editList">
          <!-- Edit rows will be dynamically added here -->
        </tbody>
      </table>
      
      <div class="button-group">
        <button class="btn submit-btn" onclick="saveEditedAttendance()">Simpan Perubahan</button>
        <button class="btn recap-btn" onclick="showSection('rekap-absen')">Kembali ke Rekap</button>
      </div>
    </section>
  </div>
<script src="js/script2.js"></script>  

  <script>
    const currentDate = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.querySelectorAll('.date-display').forEach(el => {
      el.textContent = currentDate.toLocaleDateString('id-ID', options);
    });


    const dataWithId = data.map((student, index) => ({ ...student, id: index + 1 }));

    console.log(dataWithId);

    let attendanceData = [];

    const pembimbingToStatus = {};
    data.forEach(student => {
      if (!pembimbingToStatus[student["PEMBIMBING BARU"]]) {
        pembimbingToStatus[student["PEMBIMBING BARU"]] = new Set();
      }
      pembimbingToStatus[student["PEMBIMBING BARU"]].add(student.STATUS);
    });

    const pembimbingFilter = document.getElementById('pembimbingFilter');
    const uniquePembimbing = [...new Set(data.map(student => student["PEMBIMBING BARU"]))];
    uniquePembimbing.forEach(pembimbing => {
      const option = document.createElement('option');
      option.value = pembimbing;
      option.textContent = pembimbing;
      pembimbingFilter.appendChild(option);
    });

    function updateStatusFilter() {
      const pembimbingValue = document.getElementById('pembimbingFilter').value;
      const statusFilter = document.getElementById('kelasFilter');
      statusFilter.innerHTML = '<option value="">Pilih Status</option>';

      if (pembimbingValue) {
        const statusOptions = pembimbingToStatus[pembimbingValue];
        statusOptions.forEach(status => {
          const option = document.createElement('option');
          option.value = status;
          option.textContent = status;
          statusFilter.appendChild(option);
        });
      }
    }

    function filterStudents() {
      const filteredStudents = getFilteredStudents();
      populateStudentList(filteredStudents);
      updateRekapTable(filteredStudents);
      populateEditKehadiran(filteredStudents);
    }

    function populateStudentList(filteredStudents) {
      const studentList = document.getElementById('studentList');
      studentList.innerHTML = '';
      filteredStudents.forEach((student, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${student.NAMA}</td>
          <td>
            <select class="status-select" id="status-${student.id}">
              <option value="">Pilih status</option>
              <option value="hadir">Hadir</option>
              <option value="izin">Izin</option>
              <option value="sakit">Sakit</option>
              <option value="alpha">Alpha</option>
            </select>
          </td>
        `;
        studentList.appendChild(row);
      });
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function showSection(sectionId) {
      document.querySelectorAll('section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(sectionId).classList.add('active');

      const filteredStudents = getFilteredStudents();

      if (sectionId === 'edit-kehadiran') {
        document.getElementById('editDateSelector').value = formatDate(new Date());
        populateEditKehadiran(filteredStudents);
      } else if (sectionId === 'rekap-absen') {
        const currentMonth = new Date().getMonth() + 1;
        document.getElementById('monthSelector').value = currentMonth;
        updateRekapTable(filteredStudents);
      } else if (sectionId === 'input-absen') {
        populateStudentList(filteredStudents);
      }

      // Simpan status tampilan terakhir
      saveLastViewedSection(sectionId);
    }

    function getFilteredStudents() {
      const pembimbingValue = document.getElementById('pembimbingFilter').value;
      const statusValue = document.getElementById('kelasFilter').value;

      let filteredStudents = dataWithId; // Gunakan dataWithId alih-alih data

      if (pembimbingValue) {
        filteredStudents = filteredStudents.filter(student => student["PEMBIMBING BARU"] === pembimbingValue);
      }

      if (statusValue) {
        filteredStudents = filteredStudents.filter(student => student.STATUS === statusValue);
      }

      return filteredStudents;
    }

    document.getElementById('monthSelector').addEventListener('change', function() {
      const filteredStudents = getFilteredStudents();
      updateRekapTable(filteredStudents);
    });

    document.getElementById('downloadExcel').addEventListener('click', function() {
      const wb = XLSX.utils.table_to_book(document.getElementById('rekapTable'));
      XLSX.writeFile(wb, 'rekap_absensi.xlsx');
    });

    const currentMonth = new Date().getMonth() + 1;
    document.getElementById('monthSelector').value = currentMonth;

    document.getElementById('pembimbingFilter').addEventListener('change', function() {
      updateStatusFilter();
      filterStudents();
    });
    document.getElementById('kelasFilter').addEventListener('change', filterStudents);

    updateStatusFilter();
    filterStudents();
    

    // Tambahkan fungsi ini untuk memastikan tanggal yang dipilih valid
    function validateEditDate() {
      const selectedDate = document.getElementById('editDateSelector').value;
      const today = new Date().toISOString().split('T')[0];
      
      if (selectedDate > today) {
        alert('Tidak dapat mengedit absensi untuk tanggal di masa depan.');
        document.getElementById('editDateSelector').value = today;
      }
    }

    // Panggil fungsi ini saat mengubah tanggal
    document.getElementById('editDateSelector').addEventListener('change', function() {
      validateEditDate();
      populateEditKehadiran(getFilteredStudents());
    });
    

    function saveLastViewedSection(sectionId) {
      const userId = 'default_user'; // Ganti dengan ID pengguna yang sebenarnya jika ada
      
      db.collection("userSettings").doc(userId).set({
        lastViewedSection: sectionId
      }, { merge: true })
      .then(() => {
        console.log("Bagian terakhir yang dilihat berhasil disimpan");
      })
      .catch((error) => {
        console.error("Error menyimpan bagian terakhir yang dilihat: ", error);
      });
    }

    function loadLastViewedSection() {
      const userId = 'default_user'; // Ganti dengan ID pengguna yang sebenarnya jika ada
      
      db.collection("userSettings").doc(userId).get()
      .then((doc) => {
        if (doc.exists && doc.data().lastViewedSection) {
          showSection(doc.data().lastViewedSection);
        } else {
          // Jika tidak ada data tersimpan, tampilkan bagian default
          showSection('input-absen');
        }
      })
      .catch((error) => {
        console.error("Error memuat bagian terakhir yang dilihat: ", error);
        // Jika terjadi error, tampilkan bagian default
        showSection('input-absen');
      });
    }

    // Tambahkan ini di akhir script atau di dalam event listener DOMContentLoaded
    document.addEventListener('DOMContentLoaded', (event) => {
      filterStudents();
      loadLastViewedSection();
    });
  </script>
</body>
</html>
